<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Hyperion</title>

    <link href="Library/bootstrap-5.3.5-dist/css/bootstrap.min.css" rel="stylesheet"  crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="AccountBookings.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
        <a class="navbar-brand nav-logo" href="HomePage.html">Hyperion</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="DiscoverEvents.html">Explore Events</a></li>
                <li class="nav-item"><a class="nav-link" href="CreateEvent.html">Create Event</a></li>
            </ul>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <img id="navbar-profile-img" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User" width="32" height="32" class="rounded-circle me-2">
                    <strong id="navbar-user-name">User</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item" href="AccountHome.html">Dashboard</a></li>
                    <li><a class="dropdown-item" href="AccountMyEvents.html">My Events</a></li>
                    <li><a class="dropdown-item active" href="#">My Bookings</a></li>
                    <li><a class="dropdown-item" href="AccountProfile.html">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item logout-trigger" href="#">Sign out</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="AccountHome.html"><i class="bi bi-house-door-fill me-2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountMyEvents.html"><i class="bi bi-star-fill me-2"></i> My Events</a></li>
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="AccountBookings.html"><i class="bi bi-calendar-event-fill me-2"></i> My Bookings</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountProfile.html"><i class="bi bi-person-circle me-2"></i> Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountPaymentMethods.html"><i class="bi bi-credit-card-fill me-2"></i> Payment Methods</a></li>
                    <li class="nav-item"><a class="nav-link logout-trigger" href="#"><i class="bi bi-box-arrow-left me-2"></i> Sign Out</a></li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">My Bookings</h1>
            </div>

            <div class="d-flex justify-content-start mb-4">
                <div id="booking-filter-group" class="btn-group filter-pills" role="group">
                    <input type="radio" class="btn-check" name="booking-filter" id="filter-upcoming" value="upcoming" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="filter-upcoming">Upcoming</label>
                    <input type="radio" class="btn-check" name="booking-filter" id="filter-past" value="past" autocomplete="off">
                    <label class="btn btn-outline-primary" for="filter-past">Past Events</label>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th scope="col">Event</th>
                        <th scope="col">Venue</th>
                        <th scope="col">Date</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                    </thead>
                    <tbody id="bookings-table-body">
                    <tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script src="Library/bootstrap-5.3.5-dist/js/bootstrap.bundle.min.js"  crossorigin="anonymous"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('jwt_token');
        const userId = localStorage.getItem('user_id');
        if (!token || !userId) {
            localStorage.clear();
            window.location.href = 'SignIn.html';
            return;
        }

        const userName = localStorage.getItem('user_name');
        const userProfileImgUrl = localStorage.getItem('user_profile_image_url');
        const navbarUserName = document.getElementById('navbar-user-name');
        const navbarProfileImg = document.getElementById('navbar-profile-img');

        if (navbarUserName && userName) {
            navbarUserName.textContent = userName;
        }
        if (navbarProfileImg && userProfileImgUrl) {
            navbarProfileImg.src = userProfileImgUrl;
        }

        const bookingsTableBody = document.getElementById('bookings-table-body');
        const filterGroup = document.getElementById('booking-filter-group');
        let allBookings = [];

        const apiFetch = async (url, options = {}) => {
            const response = await fetch(url, { ...options, headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` } });
            if (response.status === 401) { localStorage.clear(); window.location.href = 'SignIn.html'; }
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        };

        function renderBookings(filter = 'upcoming') {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const filteredBookings = allBookings.filter(booking => {
                const eventDate = new Date(booking.event_date);
                return filter === 'upcoming' ? eventDate >= today : eventDate < today;
            });

            if (filteredBookings.length === 0) {
                bookingsTableBody.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-muted"><h5>No ${filter} bookings found.</h5>${filter === 'upcoming' ? '<a href="DiscoverEvents.html" class="btn btn-sm btn-primary mt-2">Find Events</a>' : ''}</td></tr>`;
                return;
            }

            bookingsTableBody.innerHTML = filteredBookings.map(booking => {
                const imageUrl = (booking.images && booking.images.length > 0) ? `http://localhost:8000/storage/${booking.images[0].image_url}` : 'https://placehold.co/80x50/34495E/FFFFFF?text=Event';

                // --- FIXED: Safely handle status and booking_id data types ---
                const status = booking.pivot.status ? String(booking.pivot.status).replace(/^true$/i, 'Confirmed') : 'Confirmed';
                const badgeClass = status.toLowerCase() === 'confirmed' ? 'bg-success-subtle text-success-emphasis' : 'bg-warning-subtle text-warning-emphasis';
                const bookingId = String(booking.pivot.booking_id);

                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <img src="${imageUrl}" class="table-img me-3" alt="${booking.event_name}">
                            <div>
                                <a href="EventDetails.html?id=${booking.event_id}" class="event-name-link">${booking.event_name}</a>
                                <div class="text-muted small">Order #${bookingId}</div>
                            </div>
                        </div>
                    </td>
                    <td>${booking.event_venue}</td>
                    <td>${new Date(booking.event_date).toLocaleDateString()}</td>
                    <td><span class="badge rounded-pill ${badgeClass}">${status}</span></td>
                    <td class="text-end">
                        <a href="ViewTicket.html?booking_id=${bookingId}" class="btn btn-sm btn-outline-secondary">View Ticket</a>
                    </td>
                </tr>
                `;
            }).join('');
        }

        async function initializePage() {
            try {
                allBookings = await apiFetch(`/user/${userId}/bookings`);
                allBookings.sort((a, b) => new Date(b.event_date) - new Date(a.event_date));
                renderBookings('upcoming');
            } catch (error) {
                console.error("Failed to load bookings data:", error);
                bookingsTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Could not load your bookings.</td></tr>';
            }
        }

        filterGroup.addEventListener('change', (e) => {
            if (e.target.name === 'booking-filter') {
                renderBookings(e.target.value);
            }
        });

        document.querySelectorAll('.logout-trigger').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                apiFetch('/logout', { method: 'POST' }).then(() => {
                    localStorage.clear();
                    window.location.href = 'SignIn.html';
                });
            });
        });

        initializePage();
    });
</script>

</body>
</html>
