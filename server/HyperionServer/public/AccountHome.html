<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Hyperion</title>

    <link href="Library/bootstrap-5.3.5-dist/css/bootstrap.min.css" rel="stylesheet"  crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="AccountHome.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
        <a class="navbar-brand nav-logo" href="HomePage.html">Hyperion</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="DiscoverEvents.html">Explore Events</a></li>
                <li class="nav-item"><a class="nav-link" href="CreateEvent.html">Create Event</a></li>
            </ul>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <img id="navbar-profile-img" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User" width="32" height="32" class="rounded-circle me-2">
                    <strong id="navbar-user-name">User</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item active" href="AccountHome.html">Dashboard</a></li>
                    <li><a class="dropdown-item" href="AccountMyEvents.html">My Events</a></li>
                    <li><a class="dropdown-item" href="AccountBookings.html">My Bookings</a></li>
                    <li><a class="dropdown-item" href="AccountProfile.html">Profile</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item logout-trigger" href="#">Sign out</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link active" aria-current="page" href="AccountHome.html"><i class="bi bi-house-door-fill me-2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountMyEvents.html"><i class="bi bi-star-fill me-2"></i> My Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountBookings.html"><i class="bi bi-calendar-event-fill me-2"></i> My Bookings</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountProfile.html"><i class="bi bi-person-circle me-2"></i> Profile</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountPaymentMethods.html"><i class="bi bi-credit-card-fill me-2"></i> Payment Methods</a></li>
                    <li class="nav-item"><a class="nav-link logout-trigger" href="#"><i class="bi bi-box-arrow-left me-2"></i> Sign Out</a></li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Dashboard</h1>
            </div>

            <h2 class="h4">Your Upcoming Events</h2>
            <div id="upcoming-events-container" class="row g-4 mb-5">
                <div class="col-12 text-center p-5"><div class="spinner-border text-primary" role="status"></div></div>
            </div>

            <h2 class="h4">Recent Orders</h2>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                    <tr>
                        <th scope="col">Order ID</th>
                        <th scope="col">Event Name</th>
                        <th scope="col">Date</th>
                        <th scope="col">Total Price</th>
                        <th scope="col">Status</th>
                    </tr>
                    </thead>
                    <tbody id="recent-orders-tbody">
                    <tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary" role="status"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<script src="Library/bootstrap-5.3.5-dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('jwt_token');
        const userId = localStorage.getItem('user_id');

        if (!token || !userId) {
            localStorage.clear();
            window.location.href = 'SignIn.html';
            return;
        }

        const navbarUserName = document.getElementById('navbar-user-name');
        const navbarProfileImg = document.getElementById('navbar-profile-img');
        const upcomingEventsContainer = document.getElementById('upcoming-events-container');
        const recentOrdersTbody = document.getElementById('recent-orders-tbody');

        const apiFetch = async (url, options = {}) => {
            const response = await fetch(url, { ...options, headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}` } });
            if (response.status === 401) { localStorage.clear(); window.location.href = 'SignIn.html'; throw new Error('Session expired.'); }
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        };

        const initializeUser = async () => {
            navbarUserName.textContent = localStorage.getItem('user_name') || 'User';
            const storedImg = localStorage.getItem('user_profile_image_url');
            if(storedImg) navbarProfileImg.src = storedImg;

            try {
                const user = await apiFetch(`/user/${userId}`);
                if (user) {
                    navbarUserName.textContent = user.name;
                    localStorage.setItem('user_name', user.name);
                    if(user.profile_image_url) {
                        const fullUrl = `http://localhost:8000/storage/${user.profile_image_url}`;
                        navbarProfileImg.src = fullUrl;
                        localStorage.setItem('user_profile_image_url', fullUrl);
                    }
                }
            } catch (error) {
                console.error("Could not fetch user profile for navbar.", error);
            }
        };

        function renderUpcomingEvents(bookings) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const upcomingBookings = bookings.filter(booking => new Date(booking.event_date) >= today);
            if (upcomingBookings.length === 0) {
                upcomingEventsContainer.innerHTML = `<div class="col-12"><div class="text-center p-5 bg-light rounded-3"><h5>You have no upcoming events.</h5><p class="text-muted">Time to find your next experience!</p><a href="DiscoverEvents.html" class="btn btn-primary">Explore Events</a></div></div>`;
                return;
            }
            upcomingEventsContainer.innerHTML = upcomingBookings.map(booking => {
                const imageUrl = (booking.images && booking.images.length > 0) ? `http://localhost:8000/storage/${booking.images[0].image_url}` : 'https://placehold.co/400x300/34495E/FFFFFF?text=Event';
                const bookingId = String(booking.pivot.booking_id);
                return `
                <div class="col-md-6">
                    <div class="card event-card-sm h-100">
                        <div class="row g-0">
                            <div class="col-4"><img src="${imageUrl}" class="img-fluid rounded-start" alt="${booking.event_name}"></div>
                            <div class="col-8">
                                <div class="card-body">
                                    <h5 class="card-title">${booking.event_name}</h5>
                                    <p class="card-text mb-1"><i class="bi bi-calendar-event me-1"></i> ${new Date(booking.event_date).toDateString()}</p>
                                    <a href="ViewTicket.html?booking_id=${bookingId}" class="btn btn-sm btn-outline-primary mt-2">View Ticket</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderRecentOrders(bookings) {
            if (bookings.length === 0) {
                recentOrdersTbody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted">You have no recent orders.</td></tr>`;
                return;
            }
            recentOrdersTbody.innerHTML = bookings
                .sort((a, b) => new Date(b.pivot.created_at) - new Date(a.pivot.created_at))
                .slice(0, 5)
                .map(booking => {

                    const status = (booking.pivot.status === true || String(booking.pivot.status).toLowerCase() === 'confirmed') ? 'Confirmed' : String(booking.pivot.status);
                    const badgeClass = status === 'Confirmed' ? 'bg-success' : 'bg-warning';
                    const bookingId = String(booking.pivot.booking_id);
                    const price = Number(booking.event_price || 0);

                    return `
                    <tr>
                        <td>#${bookingId}</td>
                        <td><a href="EventDetails.html?id=${booking.event_id}" class="event-name-link">${booking.event_name}</a></td>
                        <td>${new Date(booking.pivot.created_at).toLocaleDateString()}</td>
                        <td>${price.toLocaleString('fr-FR')} FCFA</td>
                        <td><span class="badge ${badgeClass}">${status}</span></td>
                    </tr>`;
                }).join('');
        }

        async function initializeDashboard() {
            try {
                const bookings = await apiFetch(`/user/${userId}/bookings`);
                renderUpcomingEvents(bookings);
                renderRecentOrders(bookings);
            } catch (error) {
                console.error("Failed to load dashboard data:", error);
                upcomingEventsContainer.innerHTML = '<div class="col"><p class="text-danger">Could not load upcoming events.</p></div>';
                recentOrdersTbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Could not load recent orders.</td></tr>';
            }
        }

        document.querySelectorAll('.logout-trigger').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                apiFetch('/logout', { method: 'POST' }).then(() => {
                    localStorage.clear();
                    window.location.href = 'SignIn.html';
                });
            });
        });

        initializeUser();
        initializeDashboard();
    });
</script>

</body>
</html>
