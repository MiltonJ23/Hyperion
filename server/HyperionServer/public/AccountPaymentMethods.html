<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Methods - Hyperion</title>

    <link href="Library/bootstrap-5.3.5-dist/css/bootstrap.min.css" rel="stylesheet"  crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="AccountPaymentMethods.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
    <div class="container">
        <a class="navbar-brand nav-logo" href="HomePage.html">Hyperion</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="DiscoverEvents.html">Explore Events</a></li>
                <li class="nav-item"><a class="nav-link" href="CreateEvent.html">Create Event</a></li>
            </ul>
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <img id="navbar-profile-img" src="https://i.pravatar.cc/150?u=a042581f4e29026704d" alt="User" width="32" height="32" class="rounded-circle me-2">
                    <strong id="navbar-user-name">User</strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item" href="AccountHome.html">Dashboard</a></li>
                    <li><a class="dropdown-item" href="AccountMyEvents.html">My Events</a></li>
                    <li><a class="dropdown-item" href="AccountBookings.html">My Bookings</a></li>
                    <li><a class="dropdown-item" href="AccountProfile.html">Profile</a></li>
                    <li><a class="dropdown-item active" href="#">Payment Methods</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item logout-trigger" href="#">Sign out</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
            <div class="position-sticky pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="AccountHome.html"><i class="bi bi-house-door-fill me-2"></i> Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountMyEvents.html"><i class="bi bi-star-fill me-2"></i> My Events</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountBookings.html"><i class="bi bi-calendar-event-fill me-2"></i> My Bookings</a></li>
                    <li class="nav-item"><a class="nav-link" href="AccountProfile.html"><i class="bi bi-person-circle me-2"></i> Profile</a></li>
                    <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-credit-card-fill me-2"></i> Payment Methods</a></li>
                    <li class="nav-item"><a class="nav-link logout-trigger" href="#"><i class="bi bi-box-arrow-left me-2"></i> Sign Out</a></li>
                </ul>
            </div>
        </nav>

        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
                <h1 class="h2">Payment Methods</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCardModal">
                    <i class="bi bi-plus-circle-fill me-2"></i>Add New Card
                </button>
            </div>

            <div id="alert-placeholder"></div>

            <div class="row">
                <div id="payment-cards-container" class="col-md-8">
                    <div class="text-center p-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>


<div class="modal fade" id="addCardModal" tabindex="-1" aria-labelledby="addCardModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCardModalLabel">Add a New Payment Method</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="add-card-form">
                    <div class="mb-3">
                        <label for="cardHolderName" class="form-label">Cardholder Name</label>
                        <input type="text" class="form-control" id="cardHolderName" required>
                    </div>
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">Card Number</label>
                        <input type="text" class="form-control" id="cardNumber" placeholder="•••• •••• •••• ••••" required maxlength="19">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="expiryDate" class="form-label">Expiry Date</label>
                            <input type="text" class="form-control" id="expiryDate" placeholder="MM/YY" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cvv" placeholder="•••" required maxlength="3">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="cardType" class="form-label">Card Type</label>
                        <select class="form-select" id="cardType" required>
                            <option value="Visa">Visa</option>
                            <option value="Mastercard">Mastercard</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="save-card-btn">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Save Card
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="Library/bootstrap-5.3.5-dist/js/bootstrap.bundle.min.js"  crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const token = localStorage.getItem('jwt_token');
        const userId = localStorage.getItem('user_id');

        if (!token || !userId) {
            localStorage.clear();
            window.location.href = 'SignIn.html';
            return;
        }

        const navbarUserName = document.getElementById('navbar-user-name');
        const navbarProfileImg = document.getElementById('navbar-profile-img');
        const userName = localStorage.getItem('user_name');
        const userProfileImgUrl = localStorage.getItem('user_profile_image_url');
        if (navbarUserName && userName) navbarUserName.textContent = userName;
        if (navbarProfileImg && userProfileImgUrl) navbarProfileImg.src = userProfileImgUrl;

        const paymentCardsContainer = document.getElementById('payment-cards-container');
        const addCardForm = document.getElementById('add-card-form');
        const saveCardBtn = document.getElementById('save-card-btn');
        const addCardModal = new bootstrap.Modal(document.getElementById('addCardModal'));
        const alertPlaceholder = document.getElementById('alert-placeholder');

        const apiFetch = async (url, options = {}) => {
            const response = await fetch(url, {
                ...options,
                headers: { 'Accept': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
            });
            if (response.status === 401) { localStorage.clear(); window.location.href = 'SignIn.html'; throw new Error('Unauthorized'); }
            const data = await response.json().catch(() => ({}));
            if (!response.ok) {
                const message = data.message || `Error: ${response.status}`;
                throw new Error(message);
            }
            return data;
        };

        const showAlert = (message, type = 'success') => {
            const wrapper = document.createElement('div');
            wrapper.innerHTML = `<div class="alert alert-${type} alert-dismissible" role="alert">${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
            alertPlaceholder.innerHTML = '';
            alertPlaceholder.append(wrapper);
        };

        function getCardIcon(provider) {
            provider = provider.toLowerCase();
            if (provider.includes('visa')) return '<i class="bi bi-credit-card-2-front-fill visa-color"></i>';
            if (provider.includes('mastercard')) return '<i class="bi bi-credit-card-2-front-fill mastercard-color"></i>';
            return '<i class="bi bi-credit-card"></i>';
        }

        function renderCards(cards) {
            if (cards.length === 0) {
                paymentCardsContainer.innerHTML = `<div class="text-center p-5 bg-light rounded">You have no saved payment methods.</div>`;
                return;
            }
            paymentCardsContainer.innerHTML = cards.map(card => `
            <div class="payment-card d-flex align-items-center" id="card-${card.bank_card_id}">
                <div class="card-logo">${getCardIcon(card.bank_provider || '')}</div>
                <div class="card-details flex-grow-1">
                    <span class="fw-bold">${card.bank_provider || 'Card'} ending in ${card.bank_card_number.slice(-4)}</span>
                    <span class="text-muted d-block">Expires ${new Date(card.date_peremption).toLocaleDateString('en-US', { month: '2-digit', year: 'numeric' })}</span>
                </div>
                <button class="btn btn-sm btn-outline-danger remove-card-btn" data-card-id="${card.bank_card_id}">Remove</button>
            </div>
        `).join('');

            document.querySelectorAll('.remove-card-btn').forEach(button => {
                button.addEventListener('click', handleRemoveCard);
            });
        }

        async function handleRemoveCard(e) {
            const cardId = e.target.dataset.cardId;
            if (!confirm('Are you sure you want to remove this card?')) return;

            try {
                await apiFetch(`/card/${cardId}`, { method: 'DELETE' });
                showAlert('Card removed successfully.', 'success');
                document.getElementById(`card-${cardId}`).remove();
            } catch(error) {
                showAlert(`Failed to remove card: ${error.message}`, 'danger');
            }
        }

        async function loadCards() {
            try {
                const cards = await apiFetch(`/user/${userId}/cards`);
                renderCards(cards);
            } catch(error) {
                console.error('Failed to load cards:', error);
                paymentCardsContainer.innerHTML = '<p class="text-danger">Could not load payment methods.</p>';
            }
        }

        addCardForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const spinner = saveCardBtn.querySelector('.spinner-border');
            spinner.classList.remove('d-none');
            saveCardBtn.disabled = true;

            const expiry = document.getElementById('expiryDate').value.split('/');
            const expiryDate = `20${expiry[1].trim()}-${expiry[0].trim()}-01`;

            const newCardData = {
                bank_card_holder_name: document.getElementById('cardHolderName').value,
                bank_card_number: document.getElementById('cardNumber').value.replace(/\s/g, ''),
                date_peremption: expiryDate,
                cvv: document.getElementById('cvv').value,
                bank_provider: document.getElementById('cardType').value,
                bank_card_type: 'Credit',
                fk_user_id: userId
            };

            try {
                await apiFetch('/card', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newCardData)
                });
                showAlert('Card added successfully!', 'success');
                addCardModal.hide();
                addCardForm.reset();
                loadCards();
            } catch(error) {
                console.error('Failed to add card:', error);
                showAlert(`Failed to add card: ${error.message}`, 'danger');
            } finally {
                spinner.classList.add('d-none');
                saveCardBtn.disabled = false;
            }
        });

        document.querySelectorAll('.logout-trigger').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                apiFetch('/logout', { method: 'POST' }).then(() => {
                    localStorage.clear();
                    window.location.href = 'SignIn.html';
                });
            });
        });

        loadCards();
    });
</script>
</body>
</html>
